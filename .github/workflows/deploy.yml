name: Deploy to S3 for CodePipeline

# Trigger on push to main branch
on:
  push:
    branches:
      - main

# Required permissions for OIDC authentication
permissions:
  id-token: write  # Required to request OIDC token
  contents: read   # Required to checkout code

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    env:
      AWS_ACCOUNT_ID: ${{ vars.AWS_ACCOUNT_ID }}
      AWS_REGION: ${{ vars.AWS_REGION }}
      AWS_PARTITION: ${{ vars.AWS_PARTITION }}
      BUCKET_NAME: ${{ vars.BUCKET_NAME }}
      ORG_REPO: ${{ vars.ORG_REPO }}
      ROLE_NAME: ${{ vars.ROLE_NAME != '' && vars.ROLE_NAME || 'project-github-actions-deploy-role' }}
    
    steps:
      - name: Debug variables
        run: |
          echo "AWS Account: ${{ env.AWS_ACCOUNT_ID }}"
          echo "Region: ${{ env.AWS_REGION }}"
          echo "Partition: ${{ env.AWS_PARTITION }}"
          echo "Role Name: ${{ env.ROLE_NAME }}"
          echo "Bucket: ${{ env.BUCKET_NAME }}"
          echo "Org-Repo: ${{ env.ORG_REPO }}"
      
      - name: Checkout code
        uses: actions/checkout@v4

      
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:${{ env.AWS_PARTITION }}:iam::${{ env.AWS_ACCOUNT_ID }}:role/project/${{ env.ROLE_NAME }}
          aws-region: ${{ env.AWS_REGION }}
          # Optional: specify role session name for audit trail
          role-session-name: GitHubActions-${{ github.event.repository.name }}-${{ github.run_id }}
      
      - name: Package source code
        run: |
          # Create zip excluding .git directory and GitHub Actions workflows
          zip -r source.zip . -x "*.git*" ".github/*"
          echo "Package size: $(du -h source.zip | cut -f1)"
      
      - name: Upload to S3
        run: |
          # Upload to S3 with metadata
          aws s3 cp source.zip \
            s3://${BUCKET_NAME}/${ORG_REPO}/main/latest.zip \
            --metadata "commit-sha=${{ github.sha }},branch=${{ github.ref_name }},actor=${{ github.actor }}"
          
          echo "âœ… Uploaded to S3: s3://${BUCKET_NAME}/${ORG_REPO}/main/latest.zip"
          echo "Commit: ${{ github.sha }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Triggered by: ${{ github.actor }}"
